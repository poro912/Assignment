<h1> 메모리 </h1>

<h2> Index </h2>

- [서론](#서론)
- [프로세스 메모리](#프로세스-메모리)
	- [텍스트](#텍스트)
	- [데이터](#데이터)
	- [스택](#스택)
	- [힙](#힙)
	- [VLA](#vla)
- [메모리 락](#메모리-락)
	- [mlock](#mlock)
	- [mlockall](#mlockall)
	- [munlock](#munlock)
	- [munlockall](#munlockall)


## 서론
C언어는 메모리관리를 프로그래머에게 맡긴다.  
따라서 메모리 사용과 해제에는 세밀한 주의가 필요하다.  
메모리는 스코프, 가상 메모리, 공유 메모리, 쓰임새 등에 따라 나뉜다.  
프로세스의 다양한 메모리와 적재위치 및 기능에 대해 설명하였으며 페이징 방지 방법을 서술하였다..  



## 프로세스 메모리
|영역	|설명|
|:--:	|:--|
|텍스트	| 실행코드 |
|데이터	| 정적 변수, 정적 심볼 |
|스택	| 로컬 자동 변수 |
|힙	| 메모리 할당 공간 |


### 텍스트 
실행코드가 존재하는 영역  
컴파일되어 실행하기위한 기계어 코드가 적재됨  
보안 프로그래밍과 같은 특수한 경우, 데이터 영역에 코드를 포함할 수 있음  


### 데이터
정적 변수나 정적 심볼들이 사용되는 영역  
|영역	|설명|
|:--:	|:--|
|.rodate	| 읽기 전용</br>const 변수 및 포맷 스트링, 상수 등 |
|.data		| 읽기/쓰기, 초기화되는 영역</br>초기값을 가지는 전역변수 |
|BSS		| 초기화되지 않는 영역</br>초기화 되지 않은 전역변수, static 변수</br>startup함수에 의해 main이 실행되기 전 0으로 초기화된다. |


### 스택
로컬 자동 변수  
함수의 시작에서 자동으로 생성되고 파기되는 변수  
스코프 영역을 벗어나면 자연적으로 파기된다.  
스택은 메모리 할당만 진행 할 뿐 해제되지 않는다.  
반환 이후에도 스택의 크기를 유지하면서 재사용된다.  
스레드 사용시에는 별도의 스택공간과 크기 설정을 가진다.


### 힙
메모리 할당 함수를 통해 얻는 공간  
프로세스 어디서든 접근 가능하다.  
자동으로 파괴되지 않기 때문에 할당, 해제, 경계면 검사를 프로그래머가 해야한다.  


### VLA
배열의 크기를 실행시에 정할 수 있도록 하는 기능  
메모리 누수를 신경쓸 필요 없으며, 속도면에서 뛰어나다.  
struct, union의 멤버로 선언될 수 없다.  
전역변수로 선언할 수 없다.  
``` c
float read_and_process(int n)
{
    float vals[n];

    for (int i = 0; i < n; i++)
        vals[i] = read_val();
    return process(vals, n);
}
```



## 메모리 락 
페이징 락 기능이라고도 한다.  
메모리 페이지에 대한 페이징(swap)을 금지하는 기능을 의미한다.  
보안이 중요한 데이터가 디스크에 저장되는 것을 방지한다.  
실시간 처리가 중요한 어플리케이션이 메모리에 접근할 때 지연을 방지한다.  
같은 주소공간에 여러번 설정되어도 중복되어 적용되지 않는다.  
시스템의 자원이나 한계에 위협적인 설정이므로 수퍼 유저의 권한 또는 특정 능력의 설정이 필요하다.  


### mlock
	int mlock(
		const void		*addr,
		size_t			len
	)
**Parametters**
- `const void *addr`	: 락을 설정할 주소
- `size_t len`		: 길이

**Return Value**
- `0`	: 성공
- `-1`	: 실패, errno 설정

**Description**  
특정 위치의 메모리 페이지를 잠근다.  
> **Warning**  
addr 매개변수가 페이지의 크기 경계에 시작되야 한다. (sysconf(_SC_PAGESIZE)로 확인 가능)  
페이지 크기의 경계(페이지 크기의 배수) 가 아니라면 오류를 발생시킬 수 있다.


### mlockall
	int mlockall(int flags)
**Parametters**
- `int flags`	: 지정할 플래그 설정  
	| 플래그	| 설명|
	| :--:		| :-- |
	| MCL_CURRENT	| 현재 프로세스에 할당된 페이지 전체에 메모리락을 진행한다. |
	| MCL_FUTURE	| 앞으로 할당되는 모든 페이지에 메모리락을 진행한다. |
	| MCL_ONFAULT	| 오류가 발생했을 때 페이지를 잠근다.</br>매핑 오류 발생시 잠금되지 않는다. |

**Return Value**
- `0`	: 성공
- `-1`	: 실패, errno 설정

**Description**  
현재 프로세스의 모든 페이지를 잠근다.  
메모리맵, 공유 메모리, 힙, 스택 등 모든 공간에 대해 메모리락을 설정한다.  
매우 높은 실시간성을 가져야 하는 프로세스 및 메모리 사용이 크지 않은 경우에 사용한다.  
> **Warning**  
시스템 한계를 초과하여 에러가 발생할 가능성이 크다. 따라서 특이한 경우가 아니라면 사용하지 않는것이 좋다.


### munlock
	int munlock(
		const void 		*addr,
		size_t			len
	)
**Parametters**
- `const void *addr`	: 락을 해제할 주소
- `size_t len`		: 길이

**Return Value**
- `0`	: 성공
- `-1`	: 실패, errno 설정

**Description**  
특정 위치의 메모리 페이지 잠금을 해제한다.


### munlockall
	int munlockall(void)

**Return Value**
- `0`	: 성공
- `-1`	: 실패, errno 설정

**Description**  
현재 프로세스의 모든 페이지 잠금을 해제한다.

